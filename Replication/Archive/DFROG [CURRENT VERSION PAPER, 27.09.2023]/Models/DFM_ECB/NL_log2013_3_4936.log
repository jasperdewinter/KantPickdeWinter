% Base_Dir  = 'G:\EBO\REB\de Winter\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\';
Base_Dir  = 'C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\';
addpath(genpath(Base_Dir));

%____________________________
% Data
% serList is the list of monthly series included in analysis
Country  = 'NL';
Datafile = 'Data\dnb\data_NL_jan12';

serList  = [1 3:5 9:11 15:18 21:24 26:37 39:46 54:75 77:79];

%______________________________
% Data transformations
% Outlier correction is currently not used!!
P.C3    = 'A';                                                              % Transformation of monthly data
% 'A' : Use 3-month growth rates
% 'M' : Use monthly growth rates
P.OC    =  0;                                                               % 2  : Replace outliers with median
                                                                            % 3  : Replace outliers with largest
                                                                            % admissable value (see Outliers)

%_____________________________
% Reference to the model function
if     P.C3 == 'A'; P.Model = 'DFM_ECB';
elseif P.C3 == 'M'; P.Model = 'DFM_ECBm';
else               error('Get P.C3 right')
end

%_____________________________
% Model parameters
% P.r P.p & P.q might be column vectors. If P.crit = P.qflag = 0 then all
% possible combinations from [P.r P.q P.p] with q <=r are used.
% Otherwise specification search is done up to the maximum values of the
% specified lists
%                                                                           %  = 0 use below lists P.r P.q and P.p
%                                                                           %  > 0 use information criteria to determine
%                                                                           %      [r p q] - preferred test = crit = 2
%                                                                           % This uses:
%                                                                           % - Bai & Ng (2002) crit min(N,T) for r
%                                                                           % - AIC                           for p
%                                                                           % - Bai & Ng (2005) test 2        for q
%                                                                           % see also 'help Estim_SPC & Estim_DFP'
%   P.r     =  8;                                                           % Nr of static  factors
%   P.q     =  5;                                                           % Nr of dynamic factors (q < r)
%   P.p     =  3;                                                           % Nr of lags in factor dynamics
%   P.cutE  =  3;                                                           % Nr of obs to cut at eos for estimation

% Use this for the q-o-q model Bai & Ng
% P.crit      = 2;                                                           % Method for spec the nr of stat factors r
% P.r         = 4;
% P.q         = 3;
% P.p         = 2;
% P.cutE      = 3;                                                           % Nr of obs to cut at eos for estimation
%
% % Use this for the q-o-q model All Combinations
P.crit      = 0;                                                         % Method for spec the nr of stat factors r
P.r         = 1:4;
P.q         = 1:3;
P.p         = 1:2;
P.cutE      = 3;                                                         % Nr of obs to cut at eos for estimation

% % Use this for the m-o-m model
% P.crit      = 0;                                                         % Method for spec the nr of stat factors r
% P.r         = 1:6;
% P.q         = 1:5;
% P.p         = 1:6;
% P.cutE      = 3;                                                         % Nr of obs to cut at eos for estimation
% 
%_____________________________
% Timing (in consec order)
T.startE  = [1980  1];                                                      % Start of estimation period              [1,4,7,10]
T.startF  = [1992  1];                                                      % Start of forecasting period             [1,4,7,10]
T.startV  = [1992  3];                                                      % Start of forecast evaluation period     [3,6,9,12]
T.endF    = [2011  9];                                                      % End of forecast evaluation period       [3,6,9,12]
T.Now     = [2015  1];                                                      % 
                                                                            % -> reference point for trimming = month on which data are downloaded + 3 years
%_____________________________
% Further parameters
fcstH     = 2;                                                              % Forecast horizon (quarters)
Q_a       = [0; 0; 1];                                                      % Pattern of GDP data availability:
                                                                            %   Q_a(i) = 1 -> prev quarter GDP
                                                                            %   is available in mnth i of quart

%_____________________________
% Output flags
plotflag  = 3;                                                              % = i -> plot forecasts done in month i
                                                                            % = 0 -> don't plot
saveflag  = 4;                                                              % > 0 -> save all   to Matlab data file
                                                                            % = 2 -> save RMSE  to wk1
                                                                            % > 2 -> save RMSE  to xls (only  7)
                                                                            % > 3 -> save Fcsts to xls (only Matlab 7)

%_____________________________
% Check dates
if ~ismember(T.startE(2),[1 4 7 10]) || ...
        ~ismember(T.startF(2),[1 4 7 10])
    error('startE & startF must be set at start of quarter')
end
if ~ismember(  T.endF(2),[3 6 9 12])
    error('endF must be set at end of quarter')
end

%__________________________________________________________________________
%                              L O A D   D A T A
%__________________________________________________________________________
F     = load([Base_Dir Datafile '.mat']);
X     = F.M.Raw(:,serList);
Date  = F.M.Date;

if     P.C3 == 'A'  ; F.L.Code(:,3) = 3;
elseif P.C3 == 'M'  ; F.L.Code(:,3) = 1;
else   error('Get P.C3 right')
end
% X     = Transform_ECB(X,F.L.Code(serList,:));
X     = Transform(X,F.L.Code(serList,:),0,0);
Y     = F.Q.y(:,1);
Y_M   = q2m(Y,F.Q.Date,Date(1,2),Date(end,2));

%__________________________________________________________________________
%                     O B T A I N   F O R E C A S T S
%__________________________________________________________________________
% Run Pseudo-realtime forecasts
Model = ['RUN_' P.Model];

[fcstR Yref fDate P] = PseudoRealTime(Model,P,X,Y_M,Date,T,fcstH,Q_a);
Period 2011-12
{Operation terminated by user during <a href="matlab:helpUtils.errorDocCallback('int2str', 'C:\Software\Matlab_2012B\toolbox\matlab\strfun\int2str.m', 21)" style="font-weight:bold">int2str</a> (<a href="matlab: opentoline('C:\Software\Matlab_2012B\toolbox\matlab\strfun\int2str.m',21,0)">line 21</a>)


In <a href="matlab:helpUtils.errorDocCallback('num2str', 'C:\Software\Matlab_2012B\toolbox\matlab\strfun\num2str.m', 68)" style="font-weight:bold">num2str</a> (<a href="matlab: opentoline('C:\Software\Matlab_2012B\toolbox\matlab\strfun\num2str.m',68,0)">line 68</a>)
                s = int2str(x);

In <a href="matlab:helpUtils.errorDocCallback('FIS', 'C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Models\DFM_ECB\Kalman\FIS.m', 49)" style="font-weight:bold">FIS</a> (<a href="matlab: opentoline('C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Models\DFM_ECB\Kalman\FIS.m',49,0)">line 49</a>)
      eval(['S = ' Model '(Par,S,' num2str(t) ');']);

In <a href="matlab:helpUtils.errorDocCallback('RUN_DFM_ECB', 'C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Models\DFM_ECB\RUN_DFM_ECB.m', 97)" style="font-weight:bold">RUN_DFM_ECB</a> (<a href="matlab: opentoline('C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Models\DFM_ECB\RUN_DFM_ECB.m',97,0)">line 97</a>)
      R_KF  = FIS([Xf yf],Q.Model,Q,R_KF);

In <a href="matlab:helpUtils.errorDocCallback('PseudoRealTime', 'C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Functions\PseudoRealTime\PseudoRealTime.m', 55)" style="font-weight:bold">PseudoRealTime</a> (<a href="matlab: opentoline('C:\Werk\Onderzoek\KOOPMAN\ECB\software_code\ecb\Factors_06_STFC_V3_LONG\Functions\PseudoRealTime\PseudoRealTime.m',55,0)">line 55</a>)
    eval(['[f Date_f P] = ' Model '(Xc,Yc,Date,h,P);']);
} 
clear
clc
tic
%__________________________________________________________________________
%              RECURSIVE EVALUATION OF FORECAST PERFORMANCE
%              Written by Marta Banbura & Gerhard Ruenstler
%                       (European Central Bank)
%
%      The program evaluates the forecast performance of the dynamic
%      factor model by Doz et al. (2005) as implemented at the ECB
%      The program runs recursive forecasts and calculates the RMSEs
%__________________________________________________________________________
clear
clc
data_now = clock;
date_now = clock;
date_now = strcat(num2str(date_now(1)),'_',num2str(date_now(2)),'_', num2str(date_now(3)), num2str(date_now(4)), num2str(date_now(5)));
diary(strcat('NL_', 'log', date_now,'.log'));
